## 缓存击穿-COE学习

同一ska商品`product_id = 2206202377 `频繁查询db，由于该商品是ska品，一次性查询5万个门店，导致db慢查询。



故障发生当天，上线了一个ska神抢手品，该品关联了5万个售卖门店。该商品变更频繁（总计变更2800多次，最频繁时一分钟3次）导致缓存失效，重新构建需要查询所有门店，且该商品为主推热卖品，频繁请求放大了缓存击穿影响。请求量超过db、sinai服务瓶颈，进而导致列表服务不可用。最终影响“圈小首页展示、惠省圈圈商品tab页展示、美天赚圈圈商品tab页展示、高达组件对圈圈商品召回” 等几个模块的成功率



**出现状况**

- DB达到瓶颈：ska品关联的门店过多，且缓存击穿，导致查询商品门店的SQL慢查询问题严重。
- 慢查询：ska神抢手品关联了5万个售卖门店。从db查询所有门店，需要一次性返回5万行数据，单次请求耗时150ms，且当时并发产生了大量集中查询。导致DB慢查询严重

- 缓存击穿：商品缓存的构建机制由多个线程共同完成



**缓存变更策略**

<img src="https://cdn.jsdelivr.net/gh/xrj123123/Images/202409102102037.jpg" style="zoom:30%;" />

- 商品变更监听线程：负责监听商品变更，当变更发生时删除缓存。**不重新构建缓存** 
- 商品查询接口：在外部查询时优先取缓存，缓存不存在时查db+sinai，并异步构建新缓存。 当缓存删除后，新缓存构建完成前，存在击穿问题，尤其在大数据高并发场景下存在较大性能隐患



**设计时为什么没考虑缓存击穿**

在缓存建立之初已识别到该风险，之所以如此设计是为了提高数据查询准确性、提升缓存利用率、降低网维成本，并且当时供给是到店品，**最大门店数1万左右**。该设计架构足以支撑该量级。**但是近期业务出现5万量级数据，超过了设计上限**。活动开始前，没有识别到该商品的特征，也没有相关的性能升级设计，导致问题暴露在生产环节。



**缓存击穿**

由于ska商品缓存失效后，需要查询sinai数据重新构建出最新的缓存。问题期间的ska商品关联的门店数约5w家，sinai接口限制了单次查询最多50个，所以一次用户请求需要同时调用sinai接口1000次。由于热点商品查询量大，假设热点数据并发查询达到10qps，则同时查询sinai就会达到1wqps。故障期间查询sinai的请求实际达到了10wqps。这种并发量打到sinai时触发了限流，这1000次请求中只有10%的请求正确返回了，但是这10%的请求无法计算出最终结果，也无法构建出缓存，缓存击穿问题无法得到缓解。

当sinai把限流逐步放开后，其中有一个请求的1000次查询全部成功了就可以构建出缓存结果，使得后续请求不会再击穿查询到sinai服务。



**门店变更频繁原因**

1. 该活动爆品，运营一直在追加门店。 
2. 门店内券包可兑换的商品售罄/非售罄（不一定是用券包购买的，也可能是自然流量购买的），会影响券包可用门店上线/下线，在商品库存售罄的那个临界点，会有人退款，也会有人购买，所以门店状态可能就会频繁变更。该券包有4w6家门店，每个门店的状态变更，都会触发圈圈商品变更流程。 



**解决方案**

1、去除缓存失效，增加主动更新缓存机制

2、增加大门店商品的限频，保证缓存构建成功同时避免对sinai、db的重复请求





