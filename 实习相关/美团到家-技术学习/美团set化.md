## 美团set化

### 1、set化介绍

SET化指的是按特定规则对业务服务架构进行纵向逻辑隔离，隔离后的服务单元是逻辑上独立的服务链路，可以提供完整的服务。SET化架构将业务的核心系统按某种**数据特征维度**进行垂直的划分，每个SET是一个能完成核心业务功能的自包含集合，在这个集合中包含了全部核心服务，以及分配给这个SET的数据、资源，每个SET的数据是全量数据按照某种维度划分后的一部分。



### 2、set化的好处
1. 系统容灾能力 通过SET化架构的流量调度能力，将SET分别部署在不同地区的数据中心，实现跨地区容灾支持； 某个数据中心故障，不会影响全网用户，此时可将故障SET的流量切到其他SET或者中心集群，实现秒级的故障恢复； 
2. 系统扩展能力 系统扩展不受地理位置和物理资源的限制，可以在不同地域选址横向扩展来满足系统日益增长的需求； SET的封装性支持更灵活的部署灵活性，比如SET一键创建/下线等； 
3. 高效本地化服务 利用前端位置信息采集和域名解析策略，将流量路由到最近的SET，避免跨IDC跨区域的访问，提供最高效的本地化服务； O2O场景天然具有本地生产，本地消费的特点，更加需要SET化支持； 
4. 服务稳定性 可以在灰度SET验证业务功能，降低系统风险；可以在压测SET评估全链路系统容量； 





### 3、流量隔离
通过统一的配置文件 /data/webapps/appenv 为主机打SET标识，默认机器的SET属性为空

```yaml
env=prod 
cell=waimai-north // 标识该机器SET属性为waimai-north，默认没有该配置
```

- SET标识在主机申请时创建，全局唯一且不可更改。
- 相同SET标识的机器组成一个逻辑隔离的SET集群，接入层、逻辑层、数据层根据此标识执行SET路由规则。
- 中间件识别SET标记，根据SET标记执行SET路由逻辑，自动寻找同SET下游服务，对业务代码无侵入。

<img src="https://cdn.jsdelivr.net/gh/xrj123123/Images/202409132115630.jpg" style="zoom:50%;" />



### 4、路由逻辑

根据用户的位置相关性，映射到对应SET，北方用户访问北方SET，南方用户访问南方SET。接入层路由服务和Oceanus集成，实现分流：

**服务层OCTO路由规则：**

| 调用者   | 被调用者 | 如何处理                                                     |
| -------- | -------- | ------------------------------------------------------------ |
| 中心服务 | SET服务  | 1. 当请求中指定SET，则请求只会发送给B下面含有SET标识的机器 <br>2. 当请求中未指定SET时，请求只会发送到B中的不含有SET标识的机器 增加过渡阶段支持 |
| SET服务  | SET服务  | 1. 如果请求没有指定SET，那么： <br>- 如果请求来自A下面含有SET标识的机器，那么请求只会发送给B下面含有同样SET标识的机器<br>- 如果请求来自A下面不含有SET标识的机器，那么请求只会发送给B下面不含有SET标识的机器 <br>2. 当请求中指定SET，则请求只会发送给B下面含有SET标识的机器 增加过渡阶段支持 |
| SET服务  | 中心服务 | 和没有SET化时的规则一样                                      |
| 中心服务 | 中心服务 | 和没有SET化时的规则一样                                      |



**具体流程图**

<img src="https://cdn.jsdelivr.net/gh/xrj123123/Images/202409132115704.jpg" style="zoom:67%;" />





### 5、容灾切换

容灾方案可根据业务需求进行灵活应用，具体比如：

1、SET间两两互备：比如业务上分为4个SET（A、B、C、D），AB互相同步数据备份，CD互相同步数据备份，SET数据不会同步到中心，当SET A挂了，可把SET A的流量切换到SET B；

2、SET数据全量同步到中心：各SET产生的交易数据会同步到中心集群，某个SET挂了，会把SET流量切回中心（需要保证中心里面部署了一套完整的交易链路，SET间两两互备不需要此条件），中心集群的容灾可通过多机房部署解决；

理论上，上述两种方案只需要业务去修改接入层路由规则即可，后面逻辑层、数据层无需修改路由规则。





### 6、数据层支持方案

- 高效率、低延迟的数据备份是容灾的前提 
- 需要为SET核心业务流程运行依赖的所有数据，提供完整的备份 
- 存储层数据备份主要做法是共享数据的单向同步，及SET数据的双向同步 

<img src="https://cdn.jsdelivr.net/gh/xrj123123/Images/202409132117919.jpg" style="zoom:80%;" />



- 其中数据库（MySQL）实现双活能力，是重中之重，挑战也很多：解决数据回环问题、数据一致性校验、双写冲突（容灾切换期间）

![](https://cdn.jsdelivr.net/gh/xrj123123/Images/202409132118928.jpg)





### 7、SET化架构模型说明

![](https://cdn.jsdelivr.net/gh/xrj123123/Images/202409132118602.jpg)



- Routing Layer：流量路由层；按照业务指定的SET划分规则，将请求指向对应的SET； 
- Business Service Layer：业务应用层； 
- Data Service Layer：数据层；Data Sync：双向数据同步 
- SET: 只负责本单元内的流量和数据处理，以实现流量拆分以及故障隔离； 各个SET之间支持流量切换和数据互备，实现容灾切换 
- Center ： 未进行SET化改造的服务，统一划分到 Center； Center 内服务，为其它SET提供服务支撑； 业务可以根据需求，在Center建设容灾能力 从业务自身视角看，其它外部业务不属于SET化体系内，都统一归为Center  







### 8、SET必须和物理机房绑定吗？

不是，它和物理机房对应更灵活：一对一，一对多，多对一

不过目前，外卖、配送、支付的每个SET都是绑定一个具体机房，其目的是为了降低跨机房访问延迟





### 9、容灾切换操作时，会有流量损失吗？

正常情况下会有少量的流量损失，也会有对应量级的脏数据需要修复。

原因：存储层集群基本采用的是数据双向同步机制，而跨地域的数据同步是有延迟的（北京To上海>30ms），备份数据不是最新的，这是受物理因素制约的。
以DTS为例，TP90能做到1秒；而由于业务侧通常有数百个甚至更多的存储集群同时运行，统计上整体同步完成评估在分钟级。





### 10、SET间数据互备有哪几种形式？

| 备份形式              | 优点                                 | 缺点                                          |
| --------------------- | ------------------------------------ | --------------------------------------------- |
| 中心维护SET数据的备份 | 两个数据副本；成本低、逻辑简单       | 中心没有容灾能力                              |
| SET两两互备           | 两个数据副本；成本低                 | 备份SET是固定的，只能在同城、异地容灾中选一个 |
| 三地五中心数据备份    | 五个数据副本；同城和异地容灾均可支持 | 成本高                                        |




