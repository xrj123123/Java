# 一、业务介绍

## 1、美团企业版

在美团到家的这段实习中，主要做的内容就是针对企业版用户在点外卖、团购、打车、差旅等场景下的消费进行管控，管控分为事前、事中、事后三个阶段，在这三个阶段分别对企业员工的消费行为进行限制。企业后台可以通过一个规则将这三个阶段串联起来。例如什么时候可以消费、单次消费限额、人均消费的上限等

- 事前：用于员工在消费前执行申请，通常是创建申请单，审批通过后才可进行消费。 
- 事中：员工在下单支付前需要在消费报备页进行报备。对于差旅场景，通常是预定机票/火车票/酒店超标时的报备申请，以及机票/火车票改签时的报备申请。
- 事后：在员工消费完成之后，对本次消费的订单进行报备（比如订单小票），然后等待审批。 



## 2、审批

我主要负责的就是审批这块业务。审批底层是基于一个流程引擎，类似activiti流程引擎。我们就是作为一个中间层，因为底层的流程引擎，只提供了一些状态流转的能力，而我们需要基于这个能力实现和前端的交互。

- 管理员可以在后台创建审批流，这个审批流是通过可视化的方式进行配置的，配置完之后，这个审批流会以一个json形式发送给后端，后端将其转为bpmn文件，然后调用底层的流程引擎去定义一个流程 
- 当用户提交一个申请时，此时会调用底层的流程引擎创建一个流程实例出来。然后审批人的各种审批动作都会基于该审批实例，实现审批节点的状态流转 
- 我们这边作为一个中间层，用户发起申请，执行审批，我们都会保存这些审批实例的状态，以及审批记录的数据，最终都是调用流程引擎实现状态流转 
- 我们在用户完成一个动作之后，会通过数据库保存当前实例的状态，以及用户的操作记录，然后发送MQ给业务方，比如是用餐还是差旅等，然后还会再发送一个MQ，这个MQ我们自己消费，主要通过开放平台接口将审批数据发送给外部企业。 
- 最后会发布一个spring事件，这个spring事件主要用于针对不同企业实现一个定制化功能的扩展。比如某些企业希望在用户提交申请、或者审批通过时，给申请人和审批人发送短信提醒。根据当前审批实例的状态，来执行不同的动作。用户提交申请时，那么此时会给审批人发送短信提醒，审批通过/驳回，给申请人发短信提醒。 



## 3、邮件审批

邮件审批就是基于这个spring事件来实现的，某些企业不想打开美团来执行审批，希望通过邮件的方式进行审批，针对这些企业，我们会执行邮件发送的动作

- 当该审批实例的状态是**完成**或者**驳回**，我们会查询申请人的信息，给申请人发送一个邮件，告知他申请被通过/驳回了 

- 当审批实例的状态就是**审批中**，那么我们就会查询该审批实例的下一个待执行任务，即需要谁进行审批。拿到审批人信息后，我们会构造邮件的内容，发送给审批人，审批人收到邮件后，可以点击通过/驳回来执行对应的审批动作。发送的邮件内容其实就是一段html代码，其中最重要的就是审批和驳回的链接，这两个链接我们使用的是原有的审批接口，只不过在后边加了一个token，token是通过将 **申请单id - bpmcode - 节点code - 审批人** 加密而得到。 

- 用户点击通过/驳回后，我们这里会校验这个token的有效性 

  - 当前审批实例状态为 **通过/驳回**，即终态，那么直接返回。返回结果为当时该审批人审批的数据（通过节点code查询历史审批记录） 
  - 当前审批实例状态为**处理中**， 如果bpmCode和ruleCode都相等，说明请求有效，执行后续审批动作 
  - 否则，返回当时该节点的审批记录。如果是或签就返回 "已被他人审批" 

- 最开始spring事件是同步执行的，本次由于邮件发送，需要查询业务方数据，较慢，因此使用线程池实现一个异步的效果

  ```
  线程池配置 
  核心线程数：10，最大线程数：100，队列：LinkedBlockingQueue，拒绝策略：失败后用调用线程来执行 
  使用的是美团动态线程池，因此核心线程数、最大线程数、队列大小都可以动态调整
  ```

  

## 4、买酒
美团目前不支持企业买酒，因此针对该诉求，实现企业买酒的需求，即针对用户买酒的行为进行一系列的消费管控。对于审批，该需求其实改动量不是很大，大部分接口都可以复用，主要就是接入新业务，根据上游的一些查询需求，做一些对应的变更。最主要的还是处理一些**一致性同步**的问题

**接入买酒**

- 配置专门用于买酒的一个审批流 
- 使用url管理平台针对审批详情页进行跳转。通过`auditBizType`、`isH5Client`、`isDetail`(是否是审批人视角)来路由 
- 针对前端改动的一些支持，比如首页待处理数量的限制（添加`auditBizType`入参）、查询审批列表时，只展示用酒的审批数据 



**一致性同步保证**

- 本次没有开启批量审批功能，如果开启的话，用户在审批中心进行审批时，请求是直接打到流程工厂的，审批侧感知不到，因此需要开启MQ，同步数据 
- 目前存在一种情况，即后台运营修改了审批流中审批人的信息，此时会造成流程引擎和审批侧状态不一致的问题（审批人数据不同）。为了解决这个问题，就需要在流程工厂数据修改后，审批侧重新查询流程工厂的数据，然后来更新审批的数据。本次通过MQ的方式来实现，即流程工厂状态变更后（节点状态流转、审批数据变更）会发送一个MQ，我们这里只需要监听这个MQ即可，监听到了后，重新查询流程工厂的数据，然后来同步审批侧数据。审批这里审批的数据，是存放在ES中的，ES存储的是该审批实例的信息，以及审批操作记录，存ES是为了解决各种复杂的查询方式 
- 查询流程引擎超时，返回数据为null，但我们目前没有重试机制。因为审批动作是基于线程池执行的，所以线程池提交任务后，我们通过`future.get`遍历每个任务，通过捕获该任务抛出的异常，如果超时或者业务异常，我们就发送一个同步性处理的MQ，审批侧监听这个MQ，重新查询流程引擎用来更新数据 